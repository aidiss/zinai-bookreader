{"version":3,"file":"plugins/plugin.archive_analytics.js","mappings":"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","sources":["webpack://@internetarchive/bookreader/./src/plugins/plugin.archive_analytics.js","webpack://@internetarchive/bookreader/./node_modules/core-js/modules/es.string.match.js"],"sourcesContent":["/* global BookReader, archive_analytics */\n/**\n * Plugin for Archive.org analytics\n */\njQuery.extend(BookReader.defaultOptions, {\n  enableArchiveAnalytics: true,\n  /** Provide a means of debugging, cause otherwise it's impossible to test locally */\n  debugArchiveAnaltyics: false,\n});\n\nBookReader.prototype.init = (function(super_) {\n  return function() {\n    super_.call(this);\n\n    if (this.options.enableArchiveAnalytics) {\n      this.bind(BookReader.eventNames.fragmentChange, () => this.archiveAnalyticsSendFragmentChange());\n    }\n  };\n})(BookReader.prototype.init);\n\n/** @private */\nBookReader.prototype.archiveAnalyticsSendFragmentChange = function() {\n  if (!window.archive_analytics) {\n    return;\n  }\n\n  const prevFragment = this.archiveAnalyticsSendFragmentChange.prevFragment;\n\n  const params = this.paramsFromCurrent();\n  const newFragment = this.fragmentFromParams(params);\n\n  if (prevFragment != newFragment) {\n    const values = {\n      bookreader: \"user_changed_view\",\n      itemid: this.bookId,\n      cache_bust: Math.random()\n    };\n    // EEK!  offsite embedding and /details/ page books look the same in analytics, otherwise!\n    values.offsite = 1;\n    values.details = 0;\n    try {\n      values.offsite = window.top.location.hostname.match(/\\.archive.org$/)\n        ? 0\n        : 1;\n      values.details =\n        !values.offsite && window.top.location.pathname.match(/^\\/details\\//)\n          ? 1\n          : 0;\n    } catch (e) {}\n    // avoids embed cross site exceptions -- but on (+) side, means it is and keeps marked offite!\n\n    // Send bookreader ping\n    archive_analytics.send_ping(values, null, \"augment_for_ao_site\");\n\n    // Also send tracking event ping\n    const additionalEventParams = this.options.lendingInfo && this.options.lendingInfo.loanId\n      ? { loanId: this.options.lendingInfo.loanId }\n      : {};\n    archive_analytics.send_event('BookReader', 'UserChangedView', window.location.pathname, additionalEventParams);\n\n    this.archiveAnalyticsSendFragmentChange.prevFragment = newFragment;\n  }\n};\n\n/**\n * Sends a tracking \"Event\". See https://developers.google.com/analytics/devguides/collection/protocol/v1/parameters#events\n * @param {string} category\n * @param {string} action\n * @param {number} [value] (must be an int)\n * @param {Object} [additionalEventParams]\n */\nBookReader.prototype.archiveAnalyticsSendEvent = function(category, action, value, additionalEventParams) {\n  if (!this.options.enableArchiveAnalytics) return;\n\n  if (this.options.debugArchiveAnaltyics) {\n    console.log(\"archiveAnalyticsSendEvent\", arguments, window.archive_analytics);\n  }\n\n  if (!window.archive_analytics) return;\n\n  additionalEventParams = additionalEventParams || {};\n  if (typeof(value) == 'number') {\n    additionalEventParams.ev = value;\n  }\n  window.archive_analytics.send_event(category, action, null, additionalEventParams);\n};\n","'use strict';\nvar fixRegExpWellKnownSymbolLogic = require('../internals/fix-regexp-well-known-symbol-logic');\nvar anObject = require('../internals/an-object');\nvar toLength = require('../internals/to-length');\nvar toString = require('../internals/to-string');\nvar requireObjectCoercible = require('../internals/require-object-coercible');\nvar advanceStringIndex = require('../internals/advance-string-index');\nvar regExpExec = require('../internals/regexp-exec-abstract');\n\n// @@match logic\nfixRegExpWellKnownSymbolLogic('match', function (MATCH, nativeMatch, maybeCallNative) {\n  return [\n    // `String.prototype.match` method\n    // https://tc39.es/ecma262/#sec-string.prototype.match\n    function match(regexp) {\n      var O = requireObjectCoercible(this);\n      var matcher = regexp == undefined ? undefined : regexp[MATCH];\n      return matcher !== undefined ? matcher.call(regexp, O) : new RegExp(regexp)[MATCH](toString(O));\n    },\n    // `RegExp.prototype[@@match]` method\n    // https://tc39.es/ecma262/#sec-regexp.prototype-@@match\n    function (string) {\n      var rx = anObject(this);\n      var S = toString(string);\n      var res = maybeCallNative(nativeMatch, rx, S);\n\n      if (res.done) return res.value;\n\n      if (!rx.global) return regExpExec(rx, S);\n\n      var fullUnicode = rx.unicode;\n      rx.lastIndex = 0;\n      var A = [];\n      var n = 0;\n      var result;\n      while ((result = regExpExec(rx, S)) !== null) {\n        var matchStr = toString(result[0]);\n        A[n] = matchStr;\n        if (matchStr === '') rx.lastIndex = advanceStringIndex(S, toLength(rx.lastIndex), fullUnicode);\n        n++;\n      }\n      return n === 0 ? null : A;\n    }\n  ];\n});\n"],"names":["jQuery","extend","BookReader","defaultOptions","enableArchiveAnalytics","debugArchiveAnaltyics","prototype","init","super_","call","options","bind","eventNames","fragmentChange","archiveAnalyticsSendFragmentChange","window","archive_analytics","prevFragment","params","paramsFromCurrent","newFragment","fragmentFromParams","values","bookreader","itemid","bookId","cache_bust","Math","random","offsite","details","top","location","hostname","match","pathname","e","send_ping","additionalEventParams","lendingInfo","loanId","send_event","archiveAnalyticsSendEvent","category","action","value","console","log","arguments","ev"],"sourceRoot":""}